import os
import xml.etree.ElementTree as ET
from difflib import unified_diff
import pandas as pd

# üîÅ Update with your folder paths
release_dir = "H:/Commit/release_folder"
local_dir = "H:/Commit/local_folder"

results = []

def read_file_lines(filepath):
    encodings = ['utf-8', 'utf-16', 'latin-1']
    for enc in encodings:
        try:
            with open(filepath, 'r', encoding=enc) as f:
                return f.readlines()
        except UnicodeDecodeError:
            continue
    raise ValueError(f"Unable to decode file: {filepath}")

def extract_name_if_formatter(xml_path):
    try:
        tree = ET.parse(xml_path)
        root = tree.getroot()
        component = root.find(".//ObjectType")
        if component is not None and "Import/Export Format" in component.attrib.get("ComponentName", ""):
            name_tag = root.find(".//Row/Name")
            return name_tag.text.strip() if name_tag is not None else None
    except:
        return None
    return None

def compare_xmls_with_line_numbers(local_path, release_path):
    local_lines = read_file_lines(local_path)
    release_lines = read_file_lines(release_path)

    diff = list(unified_diff(local_lines, release_lines, fromfile='local', tofile='release', n=0))

    results = []
    rel_line_num = 0
    for line in diff:
        if line.startswith("@@"):
            # Extract starting line number for release file (after +)
            parts = line.split()
            for part in parts:
                if part.startswith('+'):
                    try:
                        rel_line_num = int(part[1:].split(',')[0]) - 1  # line index adjustment
                    except:
                        rel_line_num = 0
        elif line.startswith("+") and not line.startswith("+++"):
            results.append((rel_line_num + 1, "Added", line.strip()))
            rel_line_num += 1
        elif line.startswith("-") and not line.startswith("---"):
            results.append((None, "Removed", line.strip()))
    return results

# Loop through release XMLs
for root, _, files in os.walk(release_dir):
    for file in files:
        if file.endswith(".xml"):
            release_xml_path = os.path.join(root, file)
            name = extract_name_if_formatter(release_xml_path)

            if name:
                local_xml_path = os.path.join(local_dir, f"{name}.xml")

                if os.path.exists(local_xml_path):
                    changes = compare_xmls_with_line_numbers(local_xml_path, release_xml_path)
                    if changes:
                        for line_num, change_type, content in changes:
                            results.append({
                                "Formatter Name": name,
                                "Release XML Path": release_xml_path,
                                "Status": "Changed",
                                "Line Number": line_num if line_num is not None else "N/A",
                                "Change Type": change_type,
                                "Change": content
                            })
                else:
                    results.append({
                        "Formatter Name": name,
                        "Release XML Path": release_xml_path,
                        "Status": "Missing in Local",
                        "Line Number": "N/A",
                        "Change Type": "N/A",
                        "Change": "N/A"
                    })

# Export to Excel
df = pd.DataFrame(results)
output_path = "H:/Commit/formatter_release_diff_with_lines.xlsx"
df.to_excel(output_path, index=False)
print(f"‚úÖ Excel with line numbers saved to: {output_path}")