-- STEP 1: Build department flow from ItemAuditTrail
WITH DepartmentFlow AS (
    SELECT 
        IA.ItemId,
        IA.OldValue AS OldDepartment,
        CASE 
            WHEN CHARINDEX('Using rule', IA.NewValue) > 0 
                THEN LEFT(IA.NewValue, CHARINDEX('Using rule', IA.NewValue) - 2)
            ELSE IA.NewValue
        END AS NewDepartment,
        IA.EffTime
    FROM ItemAuditTrail IA
    WHERE IA.FieldId = 50
),

-- STEP 2: Extract latest department tagging from ItemAuditTrail
LatestDepartment AS (
    SELECT ItemId, NewDepartment AS LatestDepartment
    FROM (
        SELECT 
            IA.ItemId,
            CASE 
                WHEN CHARINDEX('Using rule', IA.NewValue) > 0 
                    THEN LEFT(NewValue, CHARINDEX('Using rule', NewValue) - 2)
                ELSE NewValue
            END AS NewDepartment,
            ROW_NUMBER() OVER (PARTITION BY ItemId ORDER BY EffTime DESC) AS rn
        FROM ItemAuditTrail IA
        WHERE IA.FieldId = 50
    ) t
    WHERE rn = 1
)

-- STEP 3: Final full merged query
SELECT 
    IA.ItemId,

    -- Loaded values from Item Table
    ITM.UserText4 AS Loaded_NewValue,
    REPLACE(ITM.UserText6, '%', '') AS Loaded_UserText6,
    ITM.UserText5 AS Company,
    ITM.UserText7 AS Entity,

    -- TransactionType now from tradeextended
    TRED.UserText12 AS TransactionType,

    -- Account Subquery (safe)
    ISNULL(CAST((
        SELECT A.Id
        FROM dbo.Account A
        INNER JOIN dbo.Company C ON A.CompanyId = C.Id
        WHERE A.Name = ITM.UserText12 AND C.Name = ITM.UserText5
    ) AS VARCHAR), '') AS Account,

    ITM.UserText27 AS AccountType,

    -- From Audit Trail
    IA.OldValue AS OldDepartmentID,

    CASE 
        WHEN CHARINDEX('Using rule', IA.NewValue) > 0 
            THEN LEFT(IA.NewValue, CHARINDEX('Using rule', IA.NewValue) - 2)
        ELSE IA.NewValue
    END AS NewDepartmentID,

    CASE 
        WHEN CHARINDEX('Using rule', IA.NewValue) > 0 
            THEN SUBSTRING(
                IA.NewValue,
                CHARINDEX('Using rule', IA.NewValue) + 10,
                CHARINDEX(')', IA.NewValue) - (CHARINDEX('Using rule', IA.NewValue) + 10)
            )
        ELSE NULL
    END AS RuleId,

    IA.ModTime,
    IA.EffTime,
    IA.ItemType,

    -- From Trade Table
    TRD.DepartmentId AS Trade_DepartmentId,
    TRD.TradeDate,
    TRD.BookDate,
    TRD.SettleDate,
    TRD.Quantity,
    TRD.SecurityId,
    TRD.AccountId,

    -- From TradeExtended
    TRED.CompanyIdValue,
    TRED.PoolIdValue,
    TRED.MatchId,
    TRED.UserNum1,
    TRED.UserNum2,
    TRED.UserNum3,
    TRED.ItemState,
    TRED.DepartmentIdValue AS TradeExtended_DepartmentIdValue,
    TRED.Price,
    TRED.AmountValue,
    TRED.InterestRate,

    -- From LatestDepartment CTE
    LD.LatestDepartment AS Latest_Department_From_AuditTrail,

    -- Department match logic
    CASE 
        WHEN LD.LatestDepartment = TRED.DepartmentIdValue THEN 'Matched'
        ELSE 'Mismatched'
    END AS DepartmentMatchStatus,

    -- Trade Match logic
    CASE 
        WHEN TRED.MatchId = -1 THEN 'Unmatched'
        ELSE 'Matched'
    END AS MatchStatus

FROM ItemAuditTrail IA

LEFT JOIN Item ITM 
    ON IA.ItemId = ITM.Id

LEFT JOIN Trade TRD 
    ON IA.ItemId = TRD.Id

LEFT JOIN fip.tradeextended TRED 
    ON IA.ItemId = TRED.Id

LEFT JOIN LatestDepartment LD
    ON IA.ItemId = LD.ItemId

WHERE IA.FieldId = 50
ORDER BY IA.EffTime DESC;